import org.jooq.impl.DSL
import org.jooq.meta.jaxb.Logging

plugins {
    id("scala")
    id("org.jooq.jooq-codegen-gradle") version "3.20.8"
}

// TODO: Change the database driver configuration here and also in AbstractTest for the tests
val dbUrl = "jdbc:h2:~/jooq-mcve-java-2"
val dbUsername = "sa"
val dbPassword = ""

dependencies {
    jooqCodegen("com.h2database:h2:2.2.224")
    implementation("org.scala-lang:scala3-library_3:3.6.3")
    implementation("${group}:jooq:${version}")
    implementation("com.h2database:h2:2.2.224")
    testImplementation("junit:junit:4.13.2")
}

buildscript {
    dependencies {
        classpath("com.h2database:h2:2.2.224")
    }
}

tasks.register("init") {
    doLast {
        Class.forName("org.h2.Driver")

        // Alternatively, use Flyway, Liquibase, etc.
        DSL.using(dbUrl, dbUsername, dbPassword).use { ctx ->
            File("${projectDir}/src/main/resources/db/migration/init.sql")
                .readText()
                .split(";")
                .forEach { if (it.isNotEmpty()) ctx.execute(it) }
        }
    }
}

jooq {
    configuration {
        logging = Logging.DEBUG
        generator {
            name = "org.jooq.codegen.Scala3Generator"
            jdbc {
                url = dbUrl
                username = dbUsername
                password = dbPassword
            }
            database {
                name = "org.jooq.meta.h2.H2Database"
                includes = ".*"
                schemata {

                    // H2 and others are upper case by default
                    schema {
                        inputSchema = "MCVE"
                    }
                }
            }
            generate {
                isGeneratedAnnotation = false
            }
            target {
                directory = "src/main/scala"
                packageName = "org.jooq.mcve.scala.h2"
            }
        }
    }
}

tasks.named("compileScala") {
    dependsOn(tasks.named("jooqCodegen"))
}

tasks.named("jooqCodegen") {
    dependsOn(tasks.named("init"))
}
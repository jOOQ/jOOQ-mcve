import org.jooq.impl.DSL
import org.jooq.meta.jaxb.Logging
import org.testcontainers.utility.*
import org.testcontainers.containers.wait.strategy.*
import java.time.Duration

plugins {
    id("java")
    id("org.jooq.pro.jooq-codegen-gradle") version "3.20.8"
}

// TODO: Change the database driver configuration here and also in AbstractTest for the tests
val dbUsername = "MCVE"
val dbPassword = "MCVE"

dependencies {
    jooqCodegen("com.oracle.database.jdbc:ojdbc11:23.5.0.24.07")
    implementation("org.jooq.pro:jooq:${version}")
    implementation("org.testcontainers:oracle-xe:1.19.8")
    implementation("com.oracle.database.jdbc:ojdbc11:23.5.0.24.07")
    testImplementation("junit:junit:4.13.2")
}

buildscript {
    dependencies {
        classpath("org.testcontainers:oracle-xe:1.19.8")
        classpath("com.oracle.database.jdbc:ojdbc11:23.5.0.24.07")
    }
}

tasks.register("tc-start") {
    doLast {
        val db = object : org.testcontainers.containers.OracleContainer(DockerImageName.parse("gvenzl/oracle-free").asCompatibleSubstituteFor("gvenzl/oracle-xe"))
            {
                override fun getSid() = "FREEPDB1"
                override fun getDatabaseName() = "FREEPDB1"
            }
            .withUsername("$dbUsername")
            .withPassword("$dbPassword")
            .withEnv("ORACLE_PASSWORD", "$dbPassword")
            .withEnv("APP_USER", "$dbUsername")
            .withEnv("APP_USER_PASSWORD", "$dbPassword")
            .waitingFor(WaitAllStrategy()
                .withStrategy(LogMessageWaitStrategy()
                    .withRegEx(".*DATABASE IS READY TO USE!.*"))
                .withStrategy(HostPortWaitStrategy())
                .withStartupTimeout(Duration.ofMinutes(5))
            )
        db.start()

        // See https://www.jooq.org/doc/latest/manual/code-generation/codegen-system-properties/
        System.setProperty("jooq.codegen.jdbc.url", db.getJdbcUrl())
        System.setProperty("jooq.codegen.jdbc.username", db.getUsername())
        System.setProperty("jooq.codegen.jdbc.password", db.getPassword())
        System.setProperty("testcontainer.containerid", db.getContainerId())
        System.setProperty("testcontainer.imageName", db.getDockerImageName())

        Class.forName("oracle.jdbc.OracleDriver")

        // Alternatively, use Flyway, Liquibase, etc.
        DSL.using(db.getJdbcUrl(), dbUsername, dbPassword).use { ctx ->
            File("${projectDir}/src/main/resources/db/migration/init.sql")
                .readText()
                .split(";")
                .forEach { if (it.isNotEmpty()) ctx.execute(it) }
        }
    }
}

tasks.register("tc-stop") {
    doLast {
        val containerId = System.getProperty("testcontainer.containerid")
        val imageName = System.getProperty("testcontainer.imageName")

        println("Stopping testcontainer $containerId - $imageName")
        org.testcontainers.utility.ResourceReaper
            .instance()
            .stopAndRemoveContainer(containerId, imageName);
    }
}

jooq {
    configuration {
        logging = Logging.DEBUG
        generator {
            database {
                name = "org.jooq.meta.oracle.OracleDatabase"
                includes = ".*"
                schemata {

                    // PostgreSQL is lower case by default
                    schema {
                        inputSchema = "mcve"
                    }
                }
            }
            generate {
                isGeneratedAnnotation = false
            }
            target {
                directory = "$projectDir/src/main/java"
                packageName = "org.jooq.mcve.java.oracle"
            }
        }
    }
}

tasks.named("compileJava") {
    dependsOn(tasks.named("jooqCodegen"))
}

tasks.named("jooqCodegen") {
    dependsOn("tc-start")
    finalizedBy("tc-stop")
}
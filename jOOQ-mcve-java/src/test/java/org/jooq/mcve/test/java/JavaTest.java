package org.jooq.mcve.test.java;

import org.jooq.Cursor;
import org.jooq.DSLContext;
import org.jooq.Record;
import org.jooq.RecordMapper;
import org.jooq.ResultQuery;
import org.jooq.SQLDialect;
import org.jooq.impl.DSL;
import org.junit.After;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;

import java.sql.Connection;
import java.sql.DriverManager;
import java.util.Map;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;

public class JavaTest {

    private Connection connection;
    private DSLContext ctx;
    private RecordMapper<Record, Map<String, Object>> mapper;
    private String userName = "postgres";
    private String password = "test";
    private String url = "jdbc:postgresql://127.0.0.1:5432/jooq";
    private String selectQuery = "SELECT * FROM public.aqtmf_binder_section WHERE  " +
            "BINDER_SERIAL_NUM=" +
            " ? AND INDEX_NAME=? AND PARENT_INDEX_ID IN\n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            " INDEX_NAME=? AND PARENT_INDEX_ID IN\n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            " INDEX_NAME=? AND PARENT_INDEX_ID IN\n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            "  INDEX_NAME=? AND PARENT_INDEX_ID IN\n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            " INDEX_NAME=? AND PARENT_INDEX_ID IN\n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            " INDEX_NAME=? AND PARENT_INDEX_ID IN \n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            " INDEX_NAME=? AND PARENT_INDEX_ID IN \n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            " INDEX_NAME=? AND PARENT_INDEX_ID IN \n" +
            "(SELECT INDEX_ID FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND" +
            " INDEX_NAME=? AND PARENT_INDEX_NAME=? AND PARENT_INDEX_ID IN (SELECT INDEX_ID " +
            "FROM public.aqtmf_binder_section WHERE BINDER_SERIAL_NUM= ? AND INDEX_NAME=? AND" +
            " PARENT_SECTION_ID='rootNode')))))))))";
    private Object[][] data = {{84, "05.02.02 Protocol Signature Page", 84, "05.02 Site Set-up " +
            "Documentation", 84, "05 Site Management", 84, "2002083 Brandt, Wolfgang", 84,
            "Site", 84, "GERMANY", 84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF",
            84, "eTMF"},
            {84, "05.04.03 Monitoring Visit Report", 84, "05.04 Site Management", 84, "05 " +
                    "Site Management", 84, "2001744 Ponich, Terry", 84, "Site", 84, "CANADA",
                    84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84, "eTMF"},
            {84, "05.04.03 Monitoring Visit Report", 84, "05.04 Site Management", 84, "05 " +
                    "Site Management", 84, "2001744 Ponich, Terry", 84, "Site", 84, "CANADA",
                    84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84, "eTMF"},
            {84, "05.02.03 Proto_t Signature Page", 84, "05.02 Site Set-up Documentation", 84
                    , "05 Site Management", 84, "2002083 Brandt, Wolfgang", 84, "Site", 84,
                    "GERMANY", 84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84,
                    "eTMF"},
            {84, "05.05.02 Tracking Information", 84, "05.05 General", 84, "05 Site " +
                    "Management", 84, "2002271 Moreau, Jacques", 84, "Site", 84, "FRANCE", 84
                    , "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84, "eTMF"},
            {84, "05.02.03 Proto_t Signature Page", 84, "05.02 Site Set-up Documentation", 84
                    , "05 Site Management", 84, "2002083 Brandt, Wolfgang", 84, "Site", 84,
                    "GERMANY", 84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84,
                    "eTMF"},
            {84, "05.02.02 Protocol Signature Page", 84, "05.02 Site Set-up " +
                    "Documentation", 84, "05 Site Management", 84, "2002083 Brandt, Wolfgang"
                    , 84,
                    "Site", 84, "GERMANY", 84, "contents", 84, "eTMF", 84, "Quintiles IQVIA",
                    "eTMF",
                    84, "eTMF"},
            {84, "05.04.03 Monitoring Visit Report", 84, "05.04 Site Management", 84, "05 " +
                    "Site Management", 84, "2001744 Ponich, Terry", 84, "Site", 84, "CANADA",
                    84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84, "eTMF"},
            {84, "05.04.03 Monitoring Visit Report", 84, "05.04 Site Management", 84, "05 " +
                    "Site Management", 84, "2001744 Ponich, Terry", 84, "Site", 84, "CANADA",
                    84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84, "eTMF"},
            {84, "05.02.03 Proto_t Signature Page", 84, "05.02 Site Set-up Documentation", 84
                    , "05 Site Management", 84, "2002083 Brandt, Wolfgang", 84, "Site", 84,
                    "GERMANY", 84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84,
                    "eTMF"},
            {84, "05.05.02 Tracking Information", 84, "05.05 General", 84, "05 Site " +
                    "Management", 84, "2002271 Moreau, Jacques", 84, "Site", 84, "FRANCE", 84
                    , "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84, "eTMF"},
            {84, "05.02.03 Proto_t Signature Page", 84, "05.02 Site Set-up Documentation", 84
                    , "05 Site Management", 84, "2002083 Brandt, Wolfgang", 84, "Site", 84,
                    "GERMANY", 84, "contents", 84, "eTMF", 84, "Quintiles IQVIA", "eTMF", 84,
                    "eTMF"}};

    @Before
    public void setup() throws Exception {
        connection = DriverManager.getConnection(url, userName, password);
        connection.setAutoCommit(false);
        ctx = DSL.using(connection, SQLDialect.POSTGRES);
        ctx.settings().setFetchSize(100);
        ctx.settings().setExecuteLogging(true);
        ctx.settings().setFetchWarnings(true);
        ctx.settings().setQueryTimeout(1000);
    }

    @After
    public void after() throws Exception {
        ctx = null;
        connection.close();
        connection = null;
    }

    @Test
    public void mcveTest() {
        ExecutorService executor = Executors.newCachedThreadPool();
        Callable<Object> task = new Callable<Object>() {
            public Object call() {
                executeQuery();
                return null;
            }
        };
        Future<Object> future = executor.submit(task);
        try {
            System.out.println("Query execution started.");
            Object result = future.get(5, TimeUnit.SECONDS);
        } catch (TimeoutException ex) {
            Assert.fail();
        } catch (InterruptedException e) {
            Assert.fail();
        } catch (ExecutionException e) {
            Assert.fail();
        } finally {
            future.cancel(true); // may or may not desire this
        }
    }

    public void executeQuery(){
        int queryExecutionCount = 0;
        for (Object[] params : data) {
            ResultQuery query = ctx.resultQuery(selectQuery, params);
            try {
                query.attach(ctx.configuration());
                try (Cursor<Record> cursor = query.fetchLazy()) {
                    assertNotNull(cursor);
                    queryExecutionCount++;
                    while (cursor.hasNext()) {
                        Record record = cursor.fetchOne();
                        assertEquals(11, record.fields().length);
                    }
                }
            } catch (Exception e) {
                Assert.fail();
            }
        }
        assertEquals(10, queryExecutionCount);
    }
}


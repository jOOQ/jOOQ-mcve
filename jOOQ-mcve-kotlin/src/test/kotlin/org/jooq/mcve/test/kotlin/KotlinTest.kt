package org.jooq.mcve.test.kotlin

import org.jooq.DSLContext
import org.jooq.impl.DSL
import org.jooq.mcve.kotlin.tables.references.TEST
import org.junit.After
import org.junit.Assert.assertEquals
import org.junit.Assert.assertNotNull
import org.junit.Before
import org.junit.Test
import java.sql.DriverManager

class KotlinTest {

    var connection: java.sql.Connection? = null
    var ctx: DSLContext? = null

    @Before
    fun setup() {
        connection = DriverManager.getConnection("jdbc:h2:~/jooq-mcve-kotlin-2", "sa", "")
        ctx = DSL.using(connection)
        ctx().delete(TEST).execute()
    }

    @After
    fun after() {
        ctx = null
        connection!!.close()
        connection = null
    }

    fun ctx(): DSLContext = ctx!!

    @Test
    fun mcveTest() {
        assertEquals(1, ctx()
            .insertInto(TEST)
            .columns(TEST.CD)
            .values(42)
            .execute()
        )

        val record = ctx().fetchOne(TEST, TEST.CD.eq(42))
        assertNotNull(record?.id)
    }
}